<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>IOT-FARM</title>
		<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
		<script src="https://code.highcharts.com/stock/highstock.js"></script>
		<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
		

	</head>

	<body class="skin-blue sidebar-collapse sidebar-mini">
		<script src="https://code.jquery.com/jquery-2.2.4.min.js" ></script>
		<script src="https://cdn.socket.io/socket.io-1.0.0.js"></script>
		<div id="refresh">Refresh</div>
		<div id="container" style="height: 400px; min-width: 310px"></div>
		<script language="JavaScript">
			
			$(document).ready(function() {
				console.log('HTML: Ready');
				var j=0;
				var address = "192.168.0.21:5001"
	            console.log('HTML: attempting to connect to robot');
	            console.log('@' + address);
	            socket = io.connect(address);
	            var lesdatas = [];
	            socket.emit('get-humidity-sensor');
	            var requestData, chart1;
				socket.on("humidity-sensor", function(data) {
	            	console.log(data.data);
	            	lesdatas[j] = jQuery.parseJSON(data.data);
	            	j++;
				});
				
				socket.on("humidity-sensor-update", function(data) {
					console.log('Update received- ' +data.data);
					data = jQuery.parseJSON(data.data);
					console.log('Update received JSON- ' +data);
					var x = (new Date(data['date'])).getTime();
					var    y = data['moisture'];
					chart1.series[0].addPoint([x, y], true, true);
					console.log('x:'+x +'- y:'+ y);
				});
				
				
				$('#refresh').on('mousedown', function(){
		            console.log("emission de refresh");
		            socket.emit('get-humidity-sensor-update');
		        });
		        
		        setTimeout(function (socket) {
				    Highcharts.setOptions({
				        global: {
				            useUTC: false
				        }
				    });
				    // Create the chart
				     chart1 = Highcharts.stockChart('container', {
				        
				
				        rangeSelector: {
				            buttons: [{
				                count: 12,
				                type: 'hour',
				                text: '12H'
				            }, {
				                count: 1,
				                type: 'day',
				                text: '1D'
				            },
				            {
				                count: 1,
				                type: 'week',
				                text: '1W'
				            },{
				                count: 1,
				                type: 'month',
				                text: '1M'
				            }, {
				                type: 'all',
				                text: 'All'
				            }],
				            inputEnabled: false,
				            selected: 0
				        },
				
				        title: {
				            text: 'Live random data'
				        },
				
				        exporting: {
				            enabled: false
				        },
				
				        series: [{
				            name: 'Humidity Datas',
				            data: (function () {
				                // generate an array of random data
				                var data = [],
				                    time = (new Date()).getTime(),
				                    i;
				                console.log("total row"+lesdatas.length);   
				                for (i = 0; i < lesdatas.length; i = i + 1) {
				                    data.push([
				                        time = (new Date(lesdatas[i]['date'])).getTime(),
				                        lesdatas[i]['moisture']
				                        
				                    ]);
				                    //console.log("---> i: "+i+" - "+lesdatas[i]['moisture']+ " - "+ time);
				                }
				                return data;
				            }())
				        }]
				    });
				
				}
		        , 1000);
				
				//On lance le refresh
		        setInterval(function() {
					socket.emit("get-humidity-sensor-update"); 
					},30000);
		        
		        
			});
		</script>
	</body>
</html>
